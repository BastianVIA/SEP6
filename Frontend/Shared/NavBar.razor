@using Blazorise
@using Frontend.Events
@using Frontend.Model.Firebase
@using Frontend.Pages
@using Frontend.Service
@using Microsoft.OpenApi.Services
@inject IFirebaseModel FirebaseModel
@inject NavigationManager NavManager
@inject CustomAuthenticationStateProvider AuthStateProvider

<div class="navbar-container">
    <Bar Breakpoint="Breakpoint.Desktop"
         Background="Background.Dark"
         ThemeContrast="ThemeContrast.Dark">
        <BarBrand>
            FarligTigerMDB
        </BarBrand>
        <BarToggler/>
        <BarMenu>
            <BarStart>
                <BarItem>
                    <BarLink To="">Home</BarLink>
                </BarItem>
                <AuthorizeView>
                    <Authorized>
                        <BarItem>
                            <BarLink To="/FavoriteMovies">Favorite Movies</BarLink>
                        </BarItem>
                    </Authorized>
                </AuthorizeView>
                <BarItem>
                    <BarLink To="/ActorDetails/{224513}">Actor Page</BarLink>
                </BarItem>
            </BarStart>
            <BarEnd>
                <BarItem>
                    <Addons>
                        <Addon AddonType="AddonType.Body">
                            <TextEdit @bind-Text="@searchTerm" Placeholder="Search term" @onkeydown="HandleKeyDown" />
                        </Addon>
                
                        <Addon AddonType="AddonType.Body">                
                            <Dropdown>
                                <DropdownToggle Color="Color.Primary" TextWeight="TextWeight.Bold">
                                    @if (searchOptionName != null && !string.IsNullOrEmpty(searchOptionName))
                                    {
                                        @searchOptionName
                                    }
                                    else
                                    {
                                        <span>Search Options</span>
                                    }
                                </DropdownToggle>
                                <DropdownMenu>
                                    <DropdownItem Clicked="@(async () =>  await ToggleDropdown(true))">Search User</DropdownItem>
                                    <DropdownItem Clicked="@(async () =>  await ToggleDropdown(false))">Search Movie</DropdownItem>
                                </DropdownMenu>
                            </Dropdown>
                        </Addon>
                        
                        <Addon AddonType="AddonType.End">
                            <Button Color="Color.Primary" @onclick="PerformSearch">
                                <Icon Name="IconName.Search"/>
                            </Button>
                        </Addon>
                    </Addons>
                </BarItem>
                <AuthorizeView>
                    <Authorized>
                        <BarItem>
                            <Dropdown>
                                <DropdownToggle Color="Color.Primary" TextWeight="TextWeight.Bold">
                                    @displayName
                                </DropdownToggle>
                                <DropdownMenu>
                                    <DropdownItem Clicked="MyProfile">My profile</DropdownItem>
                                    <DropdownDivider/>
                                    <DropdownItem Clicked="Logout">Logout</DropdownItem>
                                </DropdownMenu>
                            </Dropdown>
                        </BarItem>
                    </Authorized>
                    <NotAuthorized>
                        <BarItem>
                            <BarLink To="SignUp_Login">Login</BarLink>
                        </BarItem>
                    </NotAuthorized>
                </AuthorizeView>
            </BarEnd>
        </BarMenu>
    </Bar>
</div>

@code {
    private string movieTitle;
    private string displayName;
    private string searchOptionName;
    private string searchTerm;
    private bool searchUsers = false;

    private void SearchForMovie()
    {
        if (movieTitle == null) return;
        NavManager.NavigateTo($"searchResult/{movieTitle}");
    }

    protected override void OnInitialized()
    {
        FirebaseModel.OnNotifyAlert += SetDisplayName;
        searchOptionName = "Search Movie";

        
    }
    
    private async Task HandleKeyDown(KeyboardEventArgs e)
    {
        if (e.Key == "Enter")
        {
            await PerformSearch();
        }
    }
    private async Task PerformSearch()
    {
        if (searchTerm == null) return;

        if (searchUsers)
        {
            searchOptionName = "Search User";
            NavManager.NavigateTo($"userSearch/{searchTerm}");
        }
        else
        {
            searchOptionName = "Search Movie";
            NavManager.NavigateTo($"searchResult/{searchTerm}");
        }

        await InvokeAsync(StateHasChanged);
    }
    

    private void SetDisplayName(object? sender, AlertEventArgs args)
    {
        if (args.Type != AlertBoxHelper.AlertType.LoginSuccess &&
            args.Type != AlertBoxHelper.AlertType.SignupSuccess) return;

        displayName = FirebaseModel.CurrentUser.DisplayName;
        StateHasChanged();
    }


    private void ToggleSearchUsers(bool isSearchUsers)
    {
        searchUsers = isSearchUsers;
    }
    
    private async Task ToggleDropdown(bool searchUsers)
    {
        this.searchUsers = searchUsers;

        if (searchUsers)
        {
            searchOptionName = "Search User";
        }
        else
        {
            searchOptionName = "Search Movie";
        }

        await InvokeAsync(StateHasChanged);
    }
    
    public void Dispose()
    {
        FirebaseModel.OnNotifyAlert -= SetDisplayName;
    }

    private void Logout()
    {
        FirebaseModel.Logout();
        AuthStateProvider.SignOut();
    }


    private void MyProfile()
    {
        NavManager.NavigateTo("/userprofile");
    }

}